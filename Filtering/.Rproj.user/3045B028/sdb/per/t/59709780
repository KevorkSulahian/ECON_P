{
    "collab_server" : "",
    "contents" : "library(dplyr)\nlibrary(writexl)\n\ndf  <- readxl::read_xlsx(\"subcat.xlsx\", sheet = \"Armstat\", col_names = TRUE) #Reading the file\ncolnames(df) <- c('Name','ID','Year','Period','Export_in_tonnas',\n                 'Export','Import_in_tonnas','Import')\ndf$Period <- NULL\ndf[,2:7] <- apply(df[,2:7],2,as.numeric)\ndf$Export <- df$Export/1000\ndf$Import <- df$Import/1000\n#Reading the main file\nmain  <- readxl::read_xlsx(\"main.xlsx\", sheet = \"Sheet1\", col_names = FALSE) \ncolnames(main) <-  c('Name','ID')\nmain$ID<-as.numeric(main$ID)\n###\n\n#Seperating titles and assigning groups to it\ntitles <- main[is.na(main$ID),'Name']\ncounter <- 1\nfor (i in c(1:nrow(titles))){\n  titles[i,'Group'] = counter\n  counter = counter +1\n}\n###\n\n##Aggregation of df by year\nyear_agg <- function(df, Year){\n  df_Year <- df[df$Year == Year,]\n  agg_df_Year <- df_Year %>%\n    group_by(ID) %>%\n    summarise(Export_in_tonnas = sum(Export_in_tonnas),\n              Export = sum(Export),\n              Import_in_tonnas = sum(Import_in_tonnas),\n              Import = sum(Import))\n  polufinal_Year_1 <- left_join(main, agg_df_Year, by = \"ID\")\n  polufinal_Year_1['Year'] <- Year\n  counter <- 0\n  for (i in c(1:nrow(polufinal_Year_1))){\n    polufinal_Year_1[i,'Group'] = counter\n    \n    if (is.na(polufinal_Year_1[i,'ID'])){\n      counter = counter +1\n      polufinal_Year_1[i,'Group'] = counter\n    }\n  }\n  polufinal_Year_1[is.na(polufinal_Year_1$ID),'Group']<- NA\n  polufinal_Year_1[3:6][is.na(polufinal_Year_1[3:6])] <- 0\n  \n  \n  agg_total_Year <-polufinal_Year_1 %>%\n    group_by(Group)  %>%\n    summarise(Total_Export_in_tonnas = sum(Export_in_tonnas),\n              Total_Export = sum(Export),\n              Total_Import_in_tonnas = sum(Import_in_tonnas),\n              Total_Import = sum(Import))\n  agg_total_Year <- agg_total_Year[complete.cases(agg_total_Year), ]\n  \n  \n  polufinal_Year_2 <- left_join(titles, agg_total_Year, by = \"Group\")\n  polufinal_Year_2['Group'] <- NULL\n  final_Year <- left_join(polufinal_Year_1,polufinal_Year_2, by = \"Name\")\n  \n  for (i in c(1:nrow(final_Year))){\n    if (is.na(final_Year[i,'ID'])){\n      final_Year[i,3:6] <- final_Year[i,9:12]\n    }\n  }\n  final_Year <- final_Year[,-c(8:12)]\n\n\nreturn (final_Year)\n}\n\nfinal_2017 <- year_agg(df,2017)\nfinal_2018 <- year_agg(df,2018)\nfirst_output <- inner_join(final_2017, final_2018, by = c(\"Name\",\"ID\"),  suffix = c(\".2017\", \".2018\"))\n\nfirst_output[,'Year.2017'] <- NULL\nfirst_output[,'Year.2018'] <- NULL\n\n##### Import\nimp1 <- first_output[first_output$ID %in% c(2711,2710,8703,8517,8471,8704,\n                                            8429,8431,3004,3102,7102,7108,2401,7601,1001,4810) ,]\n\nimp1$Group <- c(1,1,2,2,2,2,2,2,3,3,4,4,4,4,4,4)\ntitles_imp <- c(\"ՎԱՌԵԼԻՔՆԵՐ\", \"ՄԵՔԵՆԱՆԵՐ, ՍԱՐՔԱՎՈՐՈՒՄՆԵՐ ԵՎ ՏՐԱՆՍՊՈՐՏԱՅԻՆ ՄԻՋՈՑՆԵՐ\",\n                \"ՔԻՄԻԱԿԱՆ ԾԱԳՄԱՆ ԱՊՐԱՆՔՆԵՐ\",\"ՀՈՒՄՔԱՅԻՆ ԱՊՐԱՆՔՆԵՐ\")\ntotals <- imp1 %>%\n  group_by(Group) %>%\n  summarise(Import_in_tonnas.2017 = sum(Import_in_tonnas.2017),\n            Import.2017 = sum(Import.2017),\n            Import_in_tonnas.2018 = sum(Import_in_tonnas.2018),\n            Import.2018 = sum(Import.2018))\ntotals$ID <- NA\ntotals$Name <- titles_imp\nimp1 <- imp1[,c(\"Name\",\"ID\",\"Import_in_tonnas.2018\",\"Import.2018\",\"Import_in_tonnas.2017\",\"Import.2017\",\"Group\")]\n\nimp2 <- rbind(imp1,totals)\nimp2 <- imp2[order(imp2$Group,-imp2$Import_in_tonnas.2018),]\nimp2$mass_growth <- imp2$Import_in_tonnas.2018-imp2$Import_in_tonnas.2017\nimp2$price_growth <- imp2$Import.2018 - imp2$Import.2017\nimp2$Group<-NULL\noptions(scipen=999)\n\n######\n\nfirst_output <- rbind(c(\"Ընդամենը\",\"\",colSums(first_output[is.na(first_output$ID),c(3:10)]),\"-\"),first_output)\n\n\ndec1 <- first_output[first_output$ID %in% c(2603,2402,7108,2208,7607,7202,7102,7402),]\ndec1$price_growth <- dec1$Export.2018 - dec1$Export.2017                                            \ndec1$mas_growth <- dec1$Export_in_tonnas.2018 - dec1$Export_in_tonnas.2017\ndec1$quant_factor <- (dec1$Export.2017*dec1$mas_growth*100)/(dec1$Export_in_tonnas.2017*dec1$price_growth)\ndec1$price_factor <- 100-dec1$quant_factor\ndec1$pf_growth <- dec1$price_factor*dec1$price_growth/100\ndec1$qf_growth <- dec1$price_growth - dec1$pf_growth\ndec_final <- dec1[order(-dec1$Export.2018),c(\"Name\",\"ID\",\"Export_in_tonnas.2018\",\"Export.2018\",\"mas_growth\",\"price_growth\",\"qf_growth\",\"pf_growth\")]\ndec_final <- rbind(dec_final, c(\"Ընդամենը\",\"\",colSums(dec_final[,-c(1,2)])))\n\ndec_final[,-c(1,2)] <- round(apply(dec_final[,-c(1,2)],2,as.numeric),5)\n\n\n\n\njoin_and_output <- function(df1, df2, exp_imp){\n\n  final <- inner_join(df1, df2, by = c(\"Name\",\"ID\"),  suffix = c(\".2017\", \".2018\"))\n  if(exp_imp == \"Export\"){\n    final$Abs_Growth <- final$Export.2018 - final$Export.2017\n    final$Pct_Growth <- final$Abs_Growth * 100 / final$Export.2017\n  }\n   if(exp_imp == \"Import\"){\n    final$Abs_Growth <- final$Import.2018 - final$Import.2017\n    final$Pct_Growth <- final$Abs_Growth * 100 / final$Import.2017\n  }\n  \n  \n  groups <- final[is.na(final$ID),c(1,13)]\n  groups_sort <- groups[order(groups$Abs_Growth),]\n  groups_sort['ord']<-order(groups_sort$Abs_Growth)\n  final <- left_join(final,groups_sort[,c(1,3)],by=\"Name\")\n  for (i in c(1:nrow(final))){\n    if (is.na(final[i,'ID'])){\n      counter <- final[i,'ord']\n    }\n    final[i,'ord'] = counter\n  }\n  counter <- 0\n  for (i in c(1:nrow(final))){\n    if (is.na(final[i,'ID'])){\n      counter = counter + 1\n      final[i,'ord2'] <- counter\n      counter = counter + 1\n    } \n    else {\n      final[i,'ord2'] <- counter\n    }\n  }\n  final <- final[order(-final$ord, final$ord2, -final[,paste0(exp_imp,\".2018\")]),]\n  counter <- 1\n  for (i in c(1:nrow(final))){\n    if (is.na(final[i,'ID'])){\n      final[i,'rank_price'] <- 0\n      counter <- 1\n    } \n    else {\n      final[i,'rank_price'] <- counter\n      counter = counter +1\n    }\n  }\n  final <- final[order(-final$ord, final$ord2, -final$Abs_Growth),]\n  counter <- 1\n  for (i in c(1:nrow(final))){\n    if (is.na(final[i,'ID'])){\n      final[i,'rank_abs_growth'] <- 0\n      counter <- 1\n    } \n    else {\n      final[i,'rank_abs_growth'] <- counter\n      counter = counter +1\n    }\n  }\n  final <- final[final$rank_abs_growth<=10 | final$rank_price<=10,]\n  final <- final[,-c(15:18)]\n  options(scipen=999)\n  final[!(is.finite(final$Pct_Growth)) | (final$Pct_Growth >= 1000),\"Pct_Growth\"] <- '-'\n  # vars <-assign_var(final,exp_imp)\n  # print(vars)\n  final <- final[,c(\"Name\",\"ID\",paste0(exp_imp,\".2018\"),paste0(exp_imp,\".2017\"),\"Abs_Growth\",\"Pct_Growth\")]\n  final <- final[final[,3]>0 & final[,4] >0,]\n  final <- rbind(c(\"Ընդամենը\",\"\",colSums(final[is.na(final$ID),c(3:5)]),\"-\"),final)\n  \n  return(final)\n}\n\n\nfinal_export <- join_and_output(final_2017,final_2018,\"Export\")\nfinal_import <- join_and_output(final_2017,final_2018,\"Import\")\n\n\noptions(scipen=999)\n\n\n# install.packages(\"xlsx\")\n# library(\"xlsx\")\n# wb <- createWorkbook(type=\"xlsx\")\n# table_rownames_style <- CellStyle(wb) + Font(wb, isBold = TRUE)\n\nwrite_xlsx(first_output, 'All.xlsx')\nwrite_xlsx(final_export, 'Export.xlsx')\nwrite_xlsx(final_import, 'Import.xlsx')\n\n",
    "created" : 1535643480306.000,
    "dirty" : true,
    "encoding" : "UTF-8",
    "folds" : "",
    "hash" : "1146896929",
    "id" : "59709780",
    "lastKnownWriteTime" : 1535643013,
    "last_content_update" : 1535696617787,
    "path" : "~/Desktop/Min Economy/Filtering/Part1.R",
    "project_path" : "Part1.R",
    "properties" : {
    },
    "relative_order" : 3,
    "source_on_save" : false,
    "source_window" : "",
    "type" : "r_source"
}